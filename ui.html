<!-- <h3 id="welcome-message">Hello <span id="name-span">Ad√®le</span></h3> -->
<h2>Push your modifications</h2>
<form id="send-style-changes">
  <p>Name: <input id="name-input" /></p>
  <p>Email: <input id="email-input" /></p>
  <p>Token: <input id="token" /></p>
  <button type="submit" id="send">Send</button>
</form>

<script>
  let uxName = "";
  let uxEmail = "";

  onmessage = event => {
    const { pluginMessage } = event.data;
    switch (pluginMessage.type) {
      case "GET_STORED_UX_INFO":
        if (pluginMessage.name) {
          uxName = pluginMessage.name;
          document.getElementById("name-input").value = uxName;
        }
        if (pluginMessage.email) {
          uxEmail = pluginMessage.email;
          document.getElementById("email-input").value = uxEmail;
        }
    }
  };

  const getColorsJson = async () => {
    const colorsFileResponse = await fetch(
      "https://api.github.com/repos/Dashlane/ui-components/contents/src/globals/colors.json?ref=sync-colors"
    );

    return colorsFileResponse.json();
  };
  const getParsedDecodedColors = json => JSON.parse(window.atob(json.content));
  const updateColorsJsonContent = (token, sha, newContent, uxName, uxEmail) =>
    fetch(
      "https://api.github.com/repos/Dashlane/ui-components/contents/src/globals/colors.json",
      {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`
        },
        body: JSON.stringify({
          message: "feat(sync): testing update",
          content: window.btoa(JSON.stringify(newContent, null, 2)),
          branch: "sync-colors",
          committer: {
            name: uxName,
            email: uxEmail
          },
          sha
        })
      }
    );

  document.getElementById("send-style-changes").onsubmit = async e => {
    e.preventDefault();

    const newUxName = document.getElementById("name-input").value;
    const newUxEmail = document.getElementById("email-input").value;
    if (newUxName !== uxName || newUxEmail !== uxEmail) {
      parent.postMessage(
        {
          pluginMessage: {
            type: "SAVE_UX_INFO",
            newUxName,
            newUxEmail
          }
        },
        "*"
      );
    }

    const colorsJson = await getColorsJson();
    const colors = getParsedDecodedColors(colorsJson);

    colors.primary[100] = "test";

    const token = document.getElementById("token").value;
    await updateColorsJsonContent(
      token,
      colorsJson.sha,
      colors,
      newUxName,
      newUxEmail
    );
  };
</script>
