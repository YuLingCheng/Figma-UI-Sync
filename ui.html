<!-- <h3 id="welcome-message">Hello <span id="name-span">Ad√®le</span></h3> -->
<h2>Push your modifications</h2>
<form id="send-style-changes">
  <p>Name: <input id="name-input" /></p>
  <p>Email: <input id="email-input" /></p>
  <p>Token: <input id="token" /></p>
  <button type="submit" id="send">Send</button>
</form>

<script>
  let uxName = "";
  let uxEmail = "";

  onmessage = event => {
    const { pluginMessage } = event.data;
    switch (pluginMessage.type) {
      case "GET_STORED_UX_INFO":
        if (pluginMessage.name) {
          uxName = pluginMessage.name;
          document.getElementById("name-input").value = uxName;
        }
        if (pluginMessage.email) {
          uxEmail = pluginMessage.email;
          document.getElementById("email-input").value = uxEmail;
        }
    }
  };

  document.getElementById("send-style-changes").onsubmit = async e => {
    e.preventDefault();

    const newUxName = document.getElementById("name-input").value;
    const newUxEmail = document.getElementById("email-input").value;
    if (newUxName !== uxName || newUxEmail !== uxEmail) {
      parent.postMessage(
        {
          pluginMessage: {
            type: "SAVE_UX_INFO",
            newUxName,
            newUxEmail
          }
        },
        "*"
      );
    }

    const colorsFileResponse = await fetch(
      "https://api.github.com/repos/Dashlane/ui-components/contents/src/globals/colors.json?ref=sync-colors"
    );

    const encodedColorsFile = await colorsFileResponse.json();
    const decodedColorsFile = window.atob(encodedColorsFile.content);
    const colors = JSON.parse(decodedColorsFile);
    colors.primary[100] = "test2";

    const token = document.getElementById("token").value;
    const postResponse = await fetch(
      "https://api.github.com/repos/Dashlane/ui-components/contents/src/globals/colors.json",
      {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`
        },
        body: JSON.stringify({
          message: "feat(sync): testing committer",
          content: window.btoa(JSON.stringify(colors, null, "\t")),
          branch: "sync-colors",
          committer: {
            name: newUxName,
            email: newUxEmail
          },
          sha: encodedColorsFile.sha
        })
      }
    );

    console.log(postResponse);
  };
</script>
